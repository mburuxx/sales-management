{% extends "store/base.html" %}
{% load static %}

{% block title %}Create New Sale Order{% endblock title %}

{% block stylesheets %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<style>
    /* Styling for Select2 integration */
    .select2-container--default .select2-selection--single {
        height: calc(2.25rem + 2px); /* Match Bootstrap form-control height */
        border-radius: 0.375rem;
        border-color: #ced4da;
    }
    .select2-container--default .select2-selection--single .select2-selection__rendered {
        line-height: 2.25rem;
    }
    .select2-container--default .select2-selection--single .select2-selection__arrow {
        height: 2.25rem;
    }
    .select2-dropdown {
        border-radius: 0.375rem;
        box-shadow: var(--card-shadow);
    }
    .item-row:hover {
        background-color: #f8f9fa;
    }
    .item-row.bg-light {
        border-bottom: 1px solid #e9ecef;
    }
    #cart-summary .card-footer {
        border-top: 1px dashed #ced4da;
    }
</style>
{% endblock stylesheets %}

{% block content %}
<div class="container-fluid my-4">
    <div class="row">
        
        <div class="col-lg-8">
            <div class="card shadow-lg border-0 rounded-lg">
                
                <div class="card-header bg-primary text-white rounded-top-lg p-3">
                    <h3 class="fw-bold mb-0"><i class="fa-solid fa-cart-shopping me-2"></i> Create New Sale Order</h3>
                </div>
                
                <div class="card-body p-4">
                    <form id="saleForm" method="post">
                        {% csrf_token %}

                        <div id="alert-message" class="alert d-none" role="alert"></div>

                        <div class="mb-4 pb-3 border-bottom">
                            <h5 class="text-primary mb-3">Customer Information</h5>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="customer" class="form-label fw-semibold">Customer</label>
                                    <select id="customer" name="customer" class="form-select" required>
                                        <option value="" selected disabled>Select Customer</option>
                                        {% for customer in customers %}
                                            <option value="{{ customer.id }}">{{ customer.text }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="date_added" class="form-label fw-semibold">Sale Date</label>
                                    <input type="text" class="form-control" id="date_added" value="{{ "now"|date:"Y-m-d H:i" }}" readonly>
                                </div>
                            </div>
                        </div>

                        <div class="mb-4">
                            <h5 class="text-primary mb-3">Items to Sell</h5>
                            
                            <div class="row mb-3 align-items-end">
                                <div class="col-md-8">
                                    <label for="item_selector" class="form-label fw-semibold">Search and Add Product</label>
                                    <select id="item_selector" class="form-select"></select> 
                                </div>
                                <div class="col-md-4">
                                    <button type="button" class="btn btn-outline-primary w-100" id="addItemBtn" disabled>
                                        <i class="fa-solid fa-plus-circle me-1"></i> Add Item
                                    </button>
                                </div>
                            </div>

                            <div class="card p-0 mt-3 custom-table-wrapper">
                                <table class="table custom-table mb-0">
                                    <thead class="thead-dark">
                                        <tr>
                                            <th scope="col" style="width: 5%;">#</th>
                                            <th scope="col" style="width: 40%;">Product Name</th>
                                            <th scope="col" style="width: 15%;" class="text-center">Price</th>
                                            <th scope="col" style="width: 15%;" class="text-center">Qty</th>
                                            <th scope="col" style="width: 15%;" class="text-end">Total</th>
                                            <th scope="col" style="width: 10%;" class="text-center">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="items-list">
                                        <tr>
                                            <td colspan="6" class="text-center text-muted py-3">No items added to the sale.</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <input type="hidden" id="sub_total" name="sub_total" value="0.00">
                        <input type="hidden" id="grand_total" name="grand_total" value="0.00">
                        <input type="hidden" id="tax_amount" name="tax_amount" value="0.00">
                        <input type="hidden" id="tax_percentage" name="tax_percentage" value="0">
                        <input type="hidden" id="amount_paid_hidden" name="amount_paid" value="0.00">
                        <input type="hidden" id="amount_change_hidden" name="amount_change" value="0.00">

                        <div class="d-flex justify-content-between pt-3 mt-4 border-top">
                            <a href="{% url 'sales-list' %}" class="btn btn-outline-secondary rounded-pill">
                                <i class="fa-solid fa-arrow-left me-1"></i> Cancel Sale
                            </a>
                            <button type="submit" class="btn btn-success rounded-pill shadow-sm" id="processSaleBtn" disabled>
                                <i class="fa-solid fa-check me-1"></i> Process Sale
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card shadow-lg border-0 rounded-lg sticky-top" style="top: 20px;" id="cart-summary">
                <div class="card-header bg-secondary text-white p-3">
                    <h5 class="fw-bold mb-0">Order Summary</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between py-2">
                        <span>Subtotal:</span>
                        <strong id="summary-subtotal">$0.00</strong>
                    </div>
                    <div class="d-flex justify-content-between py-2">
                        <span>Tax (<span id="summary-tax-percent">0</span>%):</span>
                        <strong id="summary-tax-amount">$0.00</strong>
                    </div>
                    <div class="d-flex justify-content-between py-2 fs-5 fw-bold text-success border-top mt-2">
                        <span>Grand Total:</span>
                        <strong id="summary-grand-total">$0.00</strong>
                    </div>
                </div>
                <div class="card-footer p-4">
                    <h5 class="text-primary mb-3">Payment</h5>
                    <div class="mb-3">
                        <label for="amount_paid" class="form-label fw-semibold">Amount Paid</label>
                        <input type="number" class="form-control form-control-lg text-end" id="amount_paid" name="amount_paid" value="0.00" min="0" step="0.01" required>
                    </div>
                    <div class="d-flex justify-content-between py-2 fs-4 fw-bold text-danger">
                        <span>Change:</span>
                        <strong id="summary-change">$0.00</strong>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block javascripts %}
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
    $(document).ready(function() {
        const saleItems = {}; // {item_id: {data}}
        const TAX_PERCENTAGE = 0.05; // Example 5% tax rate (Update as needed)
        
        // --- 1. Select2 Initialization for Item Search ---
        $('#item_selector').select2({
            placeholder: 'Search by product name or code...',
            allowClear: true,
            theme: "bootstrap",
            ajax: {
                // IMPORTANT: Replace 'YOUR_ITEM_SEARCH_URL' with the actual URL
                // This URL should return results compatible with Select2 format {id: item.id, text: item.name, price: item.price, quantity: item.quantity}
                url: '{% url "search_items" %}', 
                dataType: 'json',
                delay: 250,
                data: function (params) {
                    return {
                        q: params.term, // search term
                        page: params.page
                    };
                },
                processResults: function (data, params) {
                    params.page = params.page || 1;
                    return {
                        results: data.results,
                        pagination: {
                            more: (params.page * 10) < data.total_count
                        }
                    };
                },
                cache: true
            },
            minimumInputLength: 2,
            templateResult: formatItem,
            templateSelection: formatItemSelection
        }).on('select2:select', function (e) {
            // Enable the Add Item button when an item is selected
            $('#addItemBtn').prop('disabled', false).data('item-data', e.params.data);
        }).on('select2:clear', function (e) {
             $('#addItemBtn').prop('disabled', true).removeData('item-data');
        });

        function formatItem (item) {
            if (item.loading) return item.text;
            if (item.quantity <= 10) {
                var stock_alert = `<span class="badge bg-danger ms-2">Low Stock: ${item.quantity}</span>`;
            } else {
                var stock_alert = `<span class="badge bg-secondary ms-2">Stock: ${item.quantity}</span>`;
            }
            
            var $container = $(
                `<div class="select2-result-item">${item.text} 
                 <span class="float-end fw-bold text-primary">$${item.price.toFixed(2)}</span>
                 ${stock_alert}
                 </div>`
            );
            return $container;
        }

        function formatItemSelection (item) {
            return item.text || item.id;
        }

        // --- 2. Cart Management Functions ---
        function calculateTotal() {
            let subTotal = 0.00;
            let totalItems = Object.keys(saleItems).length;

            for (const id in saleItems) {
                const item = saleItems[id];
                const itemQuantity = parseInt(item.quantityInput.val()) || 0;
                const itemPrice = parseFloat(item.price);
                const itemTotal = itemQuantity * itemPrice;
                
                subTotal += itemTotal;
                item.totalElement.text(`$${itemTotal.toFixed(2)}`); // Update individual row total
            }

            const taxAmount = subTotal * TAX_PERCENTAGE;
            const grandTotal = subTotal + taxAmount;
            const amountPaid = parseFloat($('#amount_paid').val()) || 0.00;
            const amountChange = amountPaid > grandTotal ? amountPaid - grandTotal : 0.00;


            // Update Hidden Inputs (for form submission)
            $('#sub_total').val(subTotal.toFixed(2));
            $('#grand_total').val(grandTotal.toFixed(2));
            $('#tax_amount').val(taxAmount.toFixed(2));
            $('#tax_percentage').val(TAX_PERCENTAGE * 100);
            $('#amount_paid_hidden').val(amountPaid.toFixed(2));
            $('#amount_change_hidden').val(amountChange.toFixed(2));

            // Update Summary Display
            $('#summary-subtotal').text(`$${subTotal.toFixed(2)}`);
            $('#summary-tax-percent').text(`${TAX_PERCENTAGE * 100}`);
            $('#summary-tax-amount').text(`$${taxAmount.toFixed(2)}`);
            $('#summary-grand-total').text(`$${grandTotal.toFixed(2)}`);
            $('#summary-change').text(`$${amountChange.toFixed(2)}`);

            // Enable/Disable Process Sale Button
            const isReadyToProcess = subTotal > 0 && amountPaid >= grandTotal && totalItems > 0;
            $('#processSaleBtn').prop('disabled', !isReadyToProcess);
        }
        
        function addItemToCart(itemData) {
            const id = itemData.id;
            
            if (saleItems[id]) {
                // If item already exists, just increment quantity
                const currentQty = parseInt(saleItems[id].quantityInput.val());
                const maxQty = parseInt(saleItems[id].quantityInput.attr('max'));
                if (currentQty < maxQty) {
                    saleItems[id].quantityInput.val(currentQty + 1);
                    saleItems[id].quantityInput.trigger('change');
                } else {
                    showAlert('Cannot add more of this item, stock limit reached.', 'alert-warning');
                }
                return;
            }

            if (itemData.quantity <= 0) {
                 showAlert('This item is out of stock.', 'alert-danger');
                 return;
            }

            const rowCount = $('#items-list').children().not('.placeholder-row').length + 1;
            
            // Create DOM elements for the new row
            const row = $(`<tr class="item-row bg-light" data-item-id="${id}"></tr>`);
            
            const quantityInput = $(
                `<input type="number" class="form-control form-control-sm text-center quantity-input" 
                 value="1" min="1" max="${itemData.quantity}" 
                 data-item-id="${id}" style="width: 80px; margin: auto;">`
            );
            
            const totalElement = $(`<strong class="text-end total-element">$${itemData.price.toFixed(2)}</strong>`);
            
            const removeBtn = $(
                `<button type="button" class="btn btn-outline-danger btn-sm remove-item" data-item-id="${id}">
                    <i class="fa-solid fa-times"></i>
                </button>`
            );
            
            row.append(`<td>${rowCount}</td>`);
            row.append(`<td>${itemData.text}</td>`);
            row.append(`<td class="text-center">$${itemData.price.toFixed(2)}</td>`);
            row.append($('<td class="text-center"></td>').append(quantityInput));
            row.append($('<td class="text-end"></td>').append(totalElement));
            row.append($('<td class="text-center"></td>').append(removeBtn));

            // Store references and data
            saleItems[id] = {
                id: id,
                price: itemData.price,
                stock: itemData.quantity,
                rowElement: row,
                quantityInput: quantityInput,
                totalElement: totalElement
            };

            // Add change listener to the input
            quantityInput.on('change keyup', function() {
                const maxVal = parseInt($(this).attr('max'));
                let currentVal = parseInt($(this).val());
                
                if (currentVal < 1 || isNaN(currentVal)) {
                    currentVal = 1;
                    $(this).val(1);
                }
                if (currentVal > maxVal) {
                    currentVal = maxVal;
                    $(this).val(maxVal);
                    showAlert(`Quantity limited to available stock: ${maxVal}`, 'alert-warning');
                }
                calculateTotal();
            });

            // Remove placeholder row if it exists
            $('#items-list tr').has('td:contains("No items added")').remove();

            // Append the new row
            $('#items-list').append(row);
            
            // Recalculate totals
            calculateTotal();
            showAlert(`Product "${itemData.text}" added to cart.`, 'alert-success');
        }

        // --- 3. Event Listeners ---
        
        // Add Item Button Click
        $('#addItemBtn').on('click', function() {
            const itemData = $(this).data('item-data');
            if (itemData) {
                addItemToCart(itemData);
            }
        });

        // Remove Item Button Click (delegated event)
        $('#items-list').on('click', '.remove-item', function() {
            const id = $(this).data('item-id');
            
            // Remove from DOM and saleItems object
            delete saleItems[id];
            $(this).closest('tr').remove();
            
            // If no items left, re-add the placeholder row
            if (Object.keys(saleItems).length === 0) {
                 const placeholder = $(`<tr><td colspan="6" class="text-center text-muted py-3">No items added to the sale.</td></tr>`);
                 $('#items-list').append(placeholder);
            }

            calculateTotal();
            showAlert('Item removed from cart.', 'alert-danger');
        });

        // Amount Paid Input Change
        $('#amount_paid').on('change keyup', calculateTotal);


        // --- 4. AJAX Form Submission ---
        $('#saleForm').on('submit', function(e) {
            e.preventDefault();
            
            const customerId = $('#customer').val();
            if (!customerId) {
                showAlert('Please select a customer.', 'alert-warning');
                return;
            }

            const subTotal = parseFloat($('#sub_total').val());
            if (subTotal <= 0) {
                showAlert('Cannot process an empty sale.', 'alert-warning');
                return;
            }
            
            const amountPaid = parseFloat($('#amount_paid').val());
            const grandTotal = parseFloat($('#grand_total').val());

            if (amountPaid < grandTotal) {
                showAlert('Amount Paid must be greater than or equal to Grand Total.', 'alert-warning');
                return;
            }


            // Compile the items array for submission
            const itemsArray = [];
            for (const id in saleItems) {
                const item = saleItems[id];
                itemsArray.push({
                    id: id,
                    price: parseFloat(item.price).toFixed(2),
                    quantity: parseInt(item.quantityInput.val()),
                    total_item: parseFloat(item.quantityInput.val() * item.price).toFixed(2),
                });
            }

            // Final data object to send
            const formData = {
                csrfmiddlewaretoken: $('input[name="csrfmiddlewaretoken"]').val(),
                customer: customerId,
                sub_total: $('#sub_total').val(),
                grand_total: $('#grand_total').val(),
                tax_amount: $('#tax_amount').val(),
                tax_percentage: $('#tax_percentage').val(),
                amount_paid: $('#amount_paid_hidden').val(),
                amount_change: $('#amount_change_hidden').val(),
                items: itemsArray
            };
            
            $('#processSaleBtn').prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...');

            // AJAX call to your Django view
            $.ajax({
                type: 'POST',
                url: $(this).attr('action') || window.location.href, // Submit to current URL
                contentType: 'application/json',
                data: JSON.stringify(formData),
                success: function(response) {
                    showAlert(response.message, 'alert-success');
                    setTimeout(function() {
                        window.location.href = response.redirect;
                    }, 1000);
                },
                error: function(xhr) {
                    const error = xhr.responseJSON || { message: 'An unknown error occurred.' };
                    showAlert(error.message, 'alert-danger');
                    $('#processSaleBtn').prop('disabled', false).html('<i class="fa-solid fa-check me-1"></i> Process Sale');
                }
            });
        });

        // --- 5. Utility Functions ---
        function showAlert(message, type) {
            const alertElement = $('#alert-message');
            alertElement.removeClass('d-none alert-success alert-warning alert-danger').addClass(type).text(message);
            // Auto hide success messages
            if (type === 'alert-success') {
                setTimeout(function() {
                    alertElement.addClass('d-none');
                }, 3000);
            }
            // Scroll to the top of the form where the alert is
            $('html, body').animate({
                scrollTop: alertElement.offset().top - 100
            }, 500);
        }

        // Initial Calculation
        calculateTotal();

    });
</script>
{% endblock javascripts %}