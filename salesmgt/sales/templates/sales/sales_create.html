{% extends "store/base.html" %}
{% load static %}
{% block title %}Create Sale{% endblock title %}

{% block stylesheets %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@ttskch/select2-bootstrap4-theme@1.5.2/dist/select2-bootstrap4.min.css">

<style>
    /* Custom style for Select2 to match the theme's form control focus */
    .select2-container--bootstrap4 .select2-selection--single:focus {
        border-color: var(--primary-color) !important;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25) !important;
    }
    .select2-container--bootstrap4 .select2-selection--single {
        border-radius: 0.375rem !important; /* Match Bootstrap form-control border-radius */
    }
    
    /* Custom class for the Quantity TouchSpin inputs inside the table */
    .b-touchspin-sm .form-control {
        height: calc(1.5em + 0.5rem + 2px); /* Smaller size for table input */
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }

    /* Table Styling Consistency */
    #table_items th {
        background-color: var(--sidebar-header-bg) !important;
        color: #fff !important;
        font-weight: 600 !important;
        border: none !important;
        padding: 0.75rem 1rem !important;
        vertical-align: middle !important;
    }
    #table_items td {
        background-color: #fff;
        border-top: 1px solid #e5e7eb !important;
        padding: 0.5rem 1rem;
        vertical-align: middle;
    }
</style>
{% endblock stylesheets %}

{% block content %}
<div class="container-fluid">
    
    <div class="my-4">
        <div class="card p-4">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h4 class="display-6 mb-0" style="color: var(--primary-color);">Add New Sale</h4>
                </div>
                <div class="col-md-6 d-flex justify-content-end">
                    <a href="{% url 'sales-list' %}" class="btn btn-outline-secondary rounded-pill shadow-sm">
                        <i class="fas fa-arrow-left me-2"></i> Go back to Sales
                    </a>
                </div>
            </div>
        </div>
    </div>

    <form id="form_sale" action="{% url 'sales-create' %}" class="saleForm" method="post">
        {% csrf_token %}
        <div class="row">
            <div class="col-lg-8 mb-4">
                <div class="card shadow">
                    <div class="card-header text-white" style="background-color: var(--sidebar-header-bg);">
                        <h5 class="mb-0">Sale Items</h5>
                    </div>
                    <div class="card-body">
                        
                        <div class="mb-4">
                            <label for="searchbox_items" class="form-label fw-bold">Search Item:</label>
                            <select class="form-select" name="searchbox_items" id="searchbox_items" aria-label="Search items"></select>
                        </div>

                        <button type="button" class="btn btn-outline-danger btn-sm mb-4 deleteAll rounded-pill shadow-sm">
                            <i class="fas fa-trash-alt me-2"></i> Delete All Items
                        </button>

                        <div class="table-responsive my-3">
                            <table class="table table-sm" id="table_items">
                                <thead class="thead-dark">
                                    <tr>
                                        <th>#</th>
                                        <th>Name</th>
                                        <th class="text-end">Price</th>
                                        <th class="text-center">Quantity</th>
                                        <th class="text-end">Total</th>
                                        <th class="text-center">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-4 mb-4">
                <div class="card shadow">
                    <div class="card-header text-white" style="background-color: var(--sidebar-header-bg);">
                        <h5 class="mb-0">Sale Details</h5>
                    </div>
                    <div class="card-body">
                        
                        <div class="mb-3">
                            <label for="customer" class="form-label">Customer</label>
                            <select name="customer" class="form-select" id="customer" aria-label="Customer" required>
                                <option value="" selected disabled hidden>Select the customer</option>
                                {% for customer in customers %}
                                <option value="{{ customer.value }}">{{ customer.label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="sub_total" class="form-label">Subtotal ($)</label>
                            <input name="sub_total" type="number" step="any" class="form-control" id="sub_total" aria-label="Subtotal" value="0.00" readonly required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="tax_percentage" class="form-label">Tax Inclusive (%)</label>
                            <input name="tax_percentage" type="text" class="form-control" id="tax_percentage" aria-label="Tax Inclusive" value="0" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="tax_amount" class="form-label">Tax Amount ($)</label>
                            <input name="tax_amount" type="number" step="any" class="form-control" id="tax_amount" aria-label="Tax Amount" value="0.00" readonly required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="grand_total" class="form-label">Grand Total ($)</label>
                            <input name="grand_total" type="number" step="any" class="form-control" id="grand_total" aria-label="Grand Total" value="0.00" readonly required>
                        </div>
                        
                        <div class="mb-4">
                            <label for="amount_paid" class="form-label">Amount Paid ($)</label>
                            <input name="amount_paid" type="number" step="any" class="form-control" id="amount_paid" aria-label="Amount Paid" required>
                        </div>
                        
                        <button type="submit" class="btn btn-primary w-100 rounded-pill shadow">
                            <i class="fas fa-check-circle me-2"></i> Create Sale
                        </button>
                    </div>
                </div>
            </div>
            </div>
    </form>
</div>
{% endblock content %}

{% block javascripts %}
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js" defer></script>
<script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap4.min.js" defer></script>

<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js" defer></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-touchspin/3.1.0/jquery.bootstrap-touchspin.min.js" defer></script>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.6.15/dist/sweetalert2.all.min.js" defer></script>

<script>
    // Source: https://stackoverflow.com/a/32605063
    function roundTo(n, digits) {
        if (digits === undefined) {
            digits = 0;
        }

        var multiplicator = Math.pow(10, digits);
        n = parseFloat((n * multiplicator).toFixed(11));
        return Math.round(n) / multiplicator;
    }

    // Variable for item number in table
    var number = 1;

    // Variable to store sale details and products
    var sale = {
        products: {
            customer: 0,
            sub_total: 0.00,
            grand_total: 0.00,
            tax_amount: 0.00,
            tax_percentage: 0.00,
            amount_payed: 0.00,
            amount_change: 0.00,
            items: []
        },
        calculate_sale: function () {
            var sub_total = 0.00;
            // Ensure tax_percentage is treated as a number
            var tax_percentage = parseFloat($('input[name="tax_percentage"]').val() || 0);

            // Calculates the total for each item
            $.each(this.products.items, function (pos, dict) {
                dict.pos = pos;
                // Ensure quantity is treated as a number (it comes from TouchSpin)
                var quantity = parseInt(dict.quantity);
                dict.total_item = roundTo(quantity * dict.price, 2);
                sub_total += dict.total_item;
            });

            // Update the sale subtotal, grand total, and tax amount
            this.products.sub_total = roundTo(sub_total, 2);
            this.products.tax_amount = roundTo(this.products.sub_total * (tax_percentage / 100), 2);
            this.products.grand_total = roundTo(this.products.sub_total + this.products.tax_amount, 2);
            
            // Update UI fields
            $('input[name="sub_total"]').val(this.products.sub_total.toFixed(2));
            $('input[name="tax_amount"]').val(this.products.tax_amount.toFixed(2));
            $('input[name="grand_total"]').val(this.products.grand_total.toFixed(2));
            
            // Recalculate change if Amount Paid is available
            this.calculate_change();
        },
        calculate_change: function() {
             var grandTotal = parseFloat($('input[name="grand_total"]').val() || 0);
             var amountPaid = parseFloat($('input[name="amount_paid"]').val() || 0);
             this.products.amount_change = roundTo(amountPaid - grandTotal, 2);
             // Note: You don't have an input field for amount_change, but the value is needed for form submission
             // A change field would be beneficial for the user, but we'll stick to calculating it here.
        },
        // Adds an item to the sale object
        add_item: function (item) {
            this.products.items.push(item);
            this.list_item();
        },
        // Shows the selected item in the table
        list_item: function () {
            // Calculate the sale before rendering
            this.calculate_sale();
            
            var tblItems = $("#table_items").DataTable({
                destroy: true,
                data: this.products.items,
                // Ensure the column data keys match the product dictionary keys
                columns: [
                    {"data": "number"},
                    {"data": "name"},
                    {"data": "price"},
                    {"data": "quantity"},
                    {"data": "total_item"},
                    {"data": "id"},
                ],
                columnDefs: [
                    {
                        // Quantity
                        class: 'text-center',
                        targets: [3],
                        render: function (data, type, row) {
                            // Use a unique class for TouchSpin styling
                            return `<input name="quantity" type="text" class="form-control form-control-sm text-center b-touchspin-sm" autocomplete="off" value="${row.quantity}">`;
                        },
                    },
                    {
                        // Item price and total
                        class: 'text-end', // Aligned to the right for currency
                        targets: [2, 4],
                        render: function (data, type, row) {
                            return '$' + parseFloat(data).toFixed(2);
                        },
                    },
                    {
                        // Delete button
                        class: 'text-center',
                        targets: [-1],
                        orderable: false,
                        render: function (data, type, row) {
                            return '<a rel="delete" type="button" class="btn btn-sm btn-outline-danger" data-bs-toggle="tooltip" title="Delete item"> <i class="fas fa-trash-alt fa-xs"></i> </a>';
                        },
                    },
                ],
                rowCallback(row, data, displayNun, displayIndex, dataIndex) {
                    // Initialize TouchSpin for the quantity input
                    $(row).find("input[name='quantity']").TouchSpin({
                        min: 1,
                        max: 100, // Replace with stock if available
                        step: 1,
                        decimals: 0,
                        boostat: 1,
                        maxboostedstep: 3,
                        postfix: ''
                    });
                },
                // Added for better table initialization
                info: false,
                paging: false,
                searching: false,
            });
            
            // Re-assign the global variable after destruction/creation
            window.tblItems = tblItems;
        },
    };

    $(document).ready(function () {
        // Initialize global tblItems early
        window.tblItems = $('#table_items').DataTable({
             columnDefs: [{ targets: [-1], orderable: false }],
             info: false, paging: false, searching: false, // Ensure DT is initialized with expected properties
             data: sale.products.items // Initialize with empty data
        });
        
        // Tax percentage touchspin
        $("input[name='tax_percentage']").TouchSpin({
            min: 0,
            max: 100,
            step: 1,
            decimals: 2,
            boostat: 5,
            maxboostedstep: 10,
            postfix: '%'
        }).on('change', function () {
            sale.calculate_sale();
        });
        
        // Amount Paid keyup/change to calculate change
        $('input[name="amount_paid"]').on('change keyup', function() {
            sale.calculate_change();
        });
        
        // Select2 Customers (using standard select, no AJAX defined in your HTML for customers)
        $('#customer').select2({
            theme: 'bootstrap4', // Apply the consistent theme
            placeholder: "Select the customer",
            allowClear: true,
        }).on('select2:select', function (e) {
            // When a customer is selected
            var data = e.params.data;
            sale.products.customer = data.id; // Assuming customer.value in template is the ID
        });


        // Select2 items searchbox (using AJAX as defined in your JS)
        $('#searchbox_items').select2({
            theme: 'bootstrap4', // Apply the consistent theme
            delay: 250,
            placeholder: 'Search an item',
            minimumInputLength: 1,
            allowClear: true,
            templateResult: template_item_searchbox,
            ajax: {
                url: "{% url 'get_items' %}",
                type: 'POST',
                data: function (params) {
                    return {
                        term: params.term,
                        csrfmiddlewaretoken: $('input[name="csrfmiddlewaretoken"]').val()
                    };
                },
                processResults: function (data) {
                    return {
                        results: data
                    };
                }
            }
        }).on('select2:select', function (e) {
            // When an item is selected from the searchbox
            var data = e.params.data;
            // Add number, subtotal, and quantity of the item to the dictionary
            data.number = number;
            number++; // Increase the item number in the table
            // Add quantity/total_item properties for initial table rendering
            data.quantity = 1; 
            data.total_item = roundTo(data.quantity * data.price, 2);
            // Add the item to the sale object
            sale.add_item(data);
            // Clear the searchbox after the item is selected
            $(this).val(null).trigger('change');
        });

        // Tables Events (Using the global tblItems)
        $('#table_items tbody').on('click', 'a[rel="delete"]', function () {
            // Get the DataTables instance
            var dt = window.tblItems;
            var tr = dt.cell($(this).closest('td, li')).index();
            item_name = (dt.row(tr.row).data().name);

            Swal.fire({
                customClass: {
                    confirmButton: 'btn btn-danger mx-2',
                    cancelButton: 'btn btn-secondary'
                },
                buttonsStyling: false,
                title: "Are you sure you want to delete this item?",
                text: item_name,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Yes, delete it!',
                cancelButtonText: 'Cancel',
                reverseButtons: true,
            }).then((result) => {
                // If confirmed
                if (result.isConfirmed) {
                    // Delete the item
                    sale.products.items.splice(tr.row, 1);
                    // List the table again
                    sale.list_item();
                    Swal.fire('Item Deleted!', 'The item was removed from the sale.', 'success');
                }
            });
        }).on('change keyup', 'input[name="quantity"]', function () {
            // When an item changes its quantity
            var quantity = parseInt($(this).val());
            var dt = window.tblItems;
            var tr = dt.cell($(this).closest('td, li')).index();
            
            // Check for invalid quantity and revert to 1 if necessary
            if (isNaN(quantity) || quantity < 1) {
                quantity = 1;
                $(this).val(quantity);
            }
            
            // Update the item quantity in the sale object
            sale.products.items[tr.row].quantity = quantity;
            // Calculate the sale with the new quantity
            sale.calculate_sale();
            
            // Update the display for the item total in the table
            var newTotal = sale.products.items[tr.row].total_item;
            dt.cell(tr.row, 4).data('$' + newTotal.toFixed(2)).draw(false);
        });

        // Delete all items
        $('.deleteAll').on('click', function () {
            // If there are no items, don't do anything
            if (sale.products.items.length === 0) return false;
            // Alert the user
            Swal.fire({
                customClass: {
                    confirmButton: 'btn btn-danger mx-2',
                    cancelButton: 'btn btn-secondary'
                },
                buttonsStyling: false,
                title: "Are you sure?",
                text: "This will delete all items from the current sale.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Yes, delete all!',
                cancelButtonText: 'Cancel',
                reverseButtons: true,
            }).then((result) => {
                // If confirmed
                if (result.isConfirmed) {
                    // Remove all items from the sale object
                    sale.products.items = [];
                    number = 1; // Reset item counter
                    // Recalculate the sale and refresh table
                    sale.list_item();
                    Swal.fire('All items were eliminated!', 'The cart is now empty.', 'success');
                }
            });
        });

        // Item searchbox templateResult (Updated to use Bootstrap card styles)
        function template_item_searchbox(repo) {
            // Only show if the item has text/name
            if (!repo.name) {
                return repo.text;
            }
            return $(`
                <div class="p-2 d-flex justify-content-between align-items-center">
                    <div class="fw-bold">${repo.name}</div>
                    <div class="text-primary fw-bold">$${parseFloat(repo.price).toFixed(2)}</div>
                </div>
            `);
        }

        // On form submit
        $('form#form_sale').on('submit', function (event) {
            event.preventDefault();

            // Perform final calculations
            sale.calculate_sale(); // Ensure totals are up-to-date
            sale.calculate_change(); // Ensure change is calculated

            // Validation checks
            if (sale.products.items.length === 0) {
                 Swal.fire({ icon: 'error', title: 'Error', text: 'Please add at least one item to the sale.' });
                 return;
            }

            var amountPaid = parseFloat($('input[name="amount_paid"]').val());
            var grandTotal = sale.products.grand_total;
            
            if (amountPaid < grandTotal) {
                 Swal.fire({ icon: 'error', title: 'Error', text: 'Amount Paid cannot be less than the Grand Total.' });
                 return;
            }

            // Gather final sale details
            var formData = {
                customer: $('select[name="customer"]').val(),
                sub_total: sale.products.sub_total,
                grand_total: grandTotal,
                tax_amount: sale.products.tax_amount,
                tax_percentage: parseFloat($('input[name="tax_percentage"]').val()),
                amount_paid: amountPaid,
                amount_change: sale.products.amount_change,
                items: sale.products.items
            };

            // Get CSRF token
            var csrftoken = $('input[name="csrfmiddlewaretoken"]').val();

            // Submit the form data via AJAX
            $.ajax({
                url: $(this).attr('action'),
                type: 'POST',
                contentType: 'application/json',
                headers: {
                    'X-CSRFToken': csrftoken
                },
                data: JSON.stringify(formData),
                success: function (response) {
                    // Handle success response
                    sale.products.items = [];
                    number = 1;
                    sale.list_item();
                    $('form#form_sale').trigger('reset');
                    Swal.fire({
                        icon: 'success',
                        title: 'Success!',
                        text: 'Sale has been completed successfully!',
                        showConfirmButton: false,
                        timer: 2000
                    });
                },
                error: function (xhr) {
                    var errorText = 'An unknown error occurred.';
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorText = xhr.responseJSON.message;
                    } else if (xhr.responseText) {
                         // Fallback for non-JSON errors
                         errorText = 'Server Error: ' + xhr.statusText;
                    }
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: errorText
                    });
                }
            });
        });
        
        // Initial setup for empty table
        sale.list_item();
    });
</script>

{% endblock javascripts %}